# 高併發範例二: 抽獎

## 情境

短時間快閃抽獎，獎品 1~n 的數量為 a1~an，機率為 p1~pn，t. 抽到銘謝惠顧的機率遠大於所有獎項。

每人限抽一次，最多百萬用戶參加。

## 基本流程

1. 生成隨機數，根據隨機數決定獎項

2. 如果該獎項抽完，視為沒有中獎

## 高併發解決方案範例

+ 只選前100萬筆候選訂單，限制抽獎數量

+ 加上緩存，緩存內容:

    + 活動資訊

    + 用戶名-狀態(處裡中、已抽獎:結果)

        + 假設用戶名 int64，抽獎狀態為 short，那麼100萬個用戶數據為 10MB 左右

        + 如果在緩存上找得到用戶名，則表示已參加過，則可以直接返回。確保用戶只參加過一次

    + 分佈式鎖 : 根據中獎機率比例，放置相對應數量的整數陣列作為共享資源。0: 銘謝惠顧，1~n: 相對應獎品

    此陣列長度正好為100萬 (最大參加人數)

+ 驗證用戶資料合法性後，抽取一個整數。

+ 抽取完畢時，將資訊送進 message queue 或程式語言提供的線程安全陣列

+ 後臺程式將抽獎結果批次寫進DB

+ 若追求速度，抽籤完可直接更新緩存並返回結果；若安全性更重要一點，則可以考慮批量更新DB後，再批量更新緩存。
