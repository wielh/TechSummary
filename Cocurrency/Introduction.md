# 高併發介紹

## 場景舉例

+ 电商大促

+ 熱點新聞

+ 金融交易

+ 線上遊戲

+ 現場直播

## 高併發系統設計的目標是什麼？

高併發絕不意味著只追求高性能，這是許多人片面的理解。從宏觀角度來看，高並發系統設計的目標有三：高效能、高可用，以及高可擴展。

+ 高效能：效能體現了系統的平行處理能力，在有限的硬體投入下，提高效能意味著節省成本。

+ 高可用：表示系統可以正常服務的時間。一個全年不停機、無故障；另一個隔三差五出現上事故、宕機，用戶肯定選擇前者。另外，如果系統只能做到90%可用，也會大大拖累業務。

+ 高擴展：表示系統的擴展能力，流量高峰時能否在短時間內完成擴容，更平穩地承接峰值流量，例如雙11活動、明星離婚等熱點事件。

## 指標

+ 效能指標

   + 平均响应时间：最常用，但是缺陷很明显，对于慢请求不敏感。比如1万次请求，其中9900次是1ms，100次是100ms，则平均响应时间为1.99ms，虽然平均耗时仅增加了0.99ms，但是1%请求的响应时间已经增加了100倍。

   + TP90、TP99等分位值响应时间：将响应时间按照从小到大排序，TP90表示排在第90分位的响应时间， 分位值越大，对慢请求越敏感。

   + 吞吐量：和响应时间呈反比，比如响应时间是1ms，则吞吐量为每秒1000次。

+ 可用性指标

   + 可用性 = 平均故障时间 / 系统总运行时间，一般使用几个9来描述系统的可用性。

+ 可扩展性指标

   + 扩展性 = 性能提升比例 / 机器增加比例


## 優化方案

+ 性能優化方案

    + 多级缓存: 包括静态数据使用CDN、本地缓存、分布式缓存等。以及对缓存场景中的热点key、缓存穿透、缓存并发、数据一致性等问题的处理。

    + 分库分表和索引优化

    + 异步化: 将次要流程通过多线程、MQ、甚至延时任务进行异步处理。

    + 并发处理: 通过多线程将串行逻辑并行化。

    + 减少IO次数: 比如数据库和缓存的批量读写(Batch Insert, Update or Read)、RPC的批量接口支持。

    + 預編譯DB查詢指令: 比如 mysql 的 preparedStatement。

    + 反範式設計: 適當的反範式設計可以提高查詢效率，但會降低新增/更新效率。

    + 放寬一致性要求

    + 池化技术: 包括HTTP请求池、线程池（考虑CPU密集型还是IO密集型）、数据库和Redis连接池等。

    + 程序逻辑优化: 比如将大概率阻断执行流程的判断逻辑前置、For循环的计算逻辑优化，或者采用更高效的算法。

    + 锁选择: 读多写少的场景用乐观锁，或者考虑通过分段锁的方式减少锁冲突。

+ 可用性優化

    + 負載均衡: 使用 Message Queue 或相似技術平穩的將請求推到系統中

    + 接口层面的超时设置、重试策略和幂等设计。
    
    + 限流处理：对超过系统处理能力的请求直接拒绝或者返回错误码。

    + 阻擋重複請求 :拒絕掉短時間內重複請求，直到處理或超時

    + 监控报警

+ 可扩展性優化

    + 可以增加消費者或工作實例數量，比如 kubenete 的 Horizontal Pod Autoscaler

    + 適當分庫分表









